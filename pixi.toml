[workspace]
name = "car_diversity_selector"
version = "0.1.0"
description = "Diverse car image selection pipeline for segmentation training"
authors = ["Brad"]
channels = ["conda-forge", "nvidia"] # Added nvidia for CUDA
platforms = ["linux-64"]

[dependencies]
python = "3.10.*"
pip = "*"
numpy = ">=1.24.0,<2.0"
pillow = ">=10.0.0"
tqdm = ">=4.66.0"
scikit-learn = ">=1.3.0"
opencv = ">=4.8.0"
pyyaml = ">=6.0"
pandas = ">=2.0.0"
matplotlib = ">=3.7.0"
seaborn = ">=0.12.0"

# --- Build Tools & System Deps ---
cmake = "*"
ninja = "*"
cxx-compiler = "*"
swig = "*"
gflags = "*"
sysroot_linux-64 = "*"

# --- Math & CUDA Libraries ---
mkl = "*"
mkl-include = "*"
libblas = "*"
liblapack = "*"
cuda-toolkit = "*"
cuda-nvcc = "*"

[pypi-dependencies]
torch = ">=2.1.0"
torchvision = ">=0.16.0"
# Note: faiss-cpu is removed to avoid conflicts with your custom build
transformers = ">=4.35.0"
accelerate = ">=0.24.0"
pyiqa = ">=0.1.9"
ftfy = "*"
timm = ">=0.9.0"
cuml-cu12 = ">=24.0.0"
cudf-cu12 = ">=24.0.0"

[tasks]
# 1. Clean previous builds to ensure no caching errors
faiss-clean = "rm -rf faiss/build"

# 2. Configure CMake (The heavy lifting)
# We rely on $CONDA_PREFIX which Pixi injects automatically
faiss-config = { cmd = """
    cmake -B faiss/build -S faiss \
    -DFAISS_ENABLE_GPU=ON \
    -DFAISS_ENABLE_PYTHON=ON \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_CUDA_ARCHITECTURES="native" \
    -DBUILD_SHARED_LIBS=ON \
    -DBUILD_TESTING=OFF \
    -DCMAKE_PREFIX_PATH=$CONDA_PREFIX \
    -DPython_EXECUTABLE=$CONDA_PREFIX/bin/python \
    -DSWIG_EXECUTABLE=$CONDA_PREFIX/bin/swig \
    -DCMAKE_CXX_FLAGS="-Wno-switch-unreachable" \
    -GNinja
""", depends-on = ["faiss-clean"] }

# 3. Compile using Ninja
faiss-build = { cmd = "ninja -C faiss/build -j$(nproc)", depends-on = ["faiss-config"] }

# 4. Install the Python bindings
faiss-install = { cmd = "cd faiss/build/faiss/python && python setup.py install", depends-on = ["faiss-build"] }

# --- MASTER TASK ---
# Run this to do everything at once
build = { cmd = "echo 'FAISS Built and Installed Successfully'", depends-on = ["faiss-install"] }

# Project specific tasks
setup = "python -c 'print(\"Environment ready! Run: pixi run build\")'"
select = "python main.py"
test = "python -c 'import faiss; import torch; print(f\"PyTorch: {torch.__version__}\"); print(f\"CUDA Available: {torch.cuda.is_available()}\"); print(f\"CUDA Device: {torch.cuda.get_device_name(0) if torch.cuda.is_available() else None}\");  print(f\"Faiss Version: {faiss.__version__}\")'"